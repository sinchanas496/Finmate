<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>OCR Receipt Upload</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 min-h-screen flex flex-col items-center p-6">

  <!-- Page Header -->
  <h1 class="text-3xl font-bold text-gray-800 mb-6">📄 OCR Receipt Upload</h1>

  <!-- Upload Form Card -->
  <div class="w-full max-w-lg bg-white rounded-2xl shadow-lg p-6 mb-8">
    <form id="uploadForm" enctype="multipart/form-data" class="space-y-4">
      <div>
        <label class="block text-gray-700 font-medium mb-1">Upload Receipt</label>
        <input type="file" name="file" required
          class="w-full border border-gray-300 rounded-lg p-2 focus:ring-2 focus:ring-blue-500">
      </div>

      <button type="submit"
        class="w-full bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 rounded-lg shadow-md transition">
        Upload Receipt
      </button>
    </form>
  </div>

  <!-- Receipts Table -->
  <div class="w-full max-w-5xl bg-white rounded-2xl shadow-lg p-6">
    <h2 class="text-2xl font-bold text-gray-800 mb-4">📋 Uploaded Receipts</h2>
    <div class="overflow-x-auto">
      <table class="w-full border-collapse text-left text-sm">
        <thead class="bg-gray-200 text-gray-700 uppercase text-xs">
          <tr>
            <th class="p-3">ID</th>
            <th class="p-3">File</th>
            <th class="p-3">Vendor</th>
            <th class="p-3">Category</th>
            <th class="p-3">Amount</th>
            <th class="p-3">Date</th>
            <th class="p-3">Uploaded At</th>
          </tr>
        </thead>
        <tbody id="receiptsTable" class="divide-y divide-gray-200"></tbody>
      </table>
    </div>
  </div>

  <script>
    const API_URL = "http://localhost:5000/receipts"; // adjust backend URL
    const token = localStorage.getItem("token"); // JWT from login

    // Upload form handler
    document.getElementById("uploadForm").addEventListener("submit", async (e) => {
      e.preventDefault();
      const formData = new FormData(e.target);

      try {
        const res = await fetch(`${API_URL}/upload`, {
          method: "POST",
          headers: { Authorization: `Bearer ${token}` },
          body: formData
        });
        const data = await res.json();
        if (data.success) {
          alert("✅ Receipt uploaded successfully!");
          loadReceipts();
          e.target.reset();
        } else {
          alert("❌ Upload failed: " + data.message);
        }
      } catch (err) {
        console.error("Upload error:", err);
        alert("⚠️ Server error during upload");
      }
    });

    // Fetch & render receipts
    async function loadReceipts() {
      try {
        const res = await fetch(API_URL, {
          headers: { Authorization: `Bearer ${token}` }
        });
        const data = await res.json();
        if (data.success) {
          const tbody = document.getElementById("receiptsTable");
          tbody.innerHTML = "";
          data.data.forEach(r => {
            const row = `
              <tr class="hover:bg-gray-50 transition">
                <td class="p-3">${r.receipt_id}</td>
                <td class="p-3">
                  <a href="${r.file_path.startsWith('/') ? r.file_path : '/' + r.file_path}" 
   target="_blank" class="text-blue-600 underline">View</a>

                </td>
                <td class="p-3">${r.vendor || '-'}</td>
                <td class="p-3">${r.category || '-'}</td>
                <td class="p-3">${r.amount || '-'}</td>
                <td class="p-3">${r.receipt_date || '-'}</td>
                <td class="p-3">${new Date(r.uploaded_at).toLocaleString()}</td>
              </tr>
            `;
            tbody.innerHTML += row;
          });
        }
      } catch (err) {
        console.error("Fetch error:", err);
      }
    }

    // Load receipts initially
    loadReceipts();
  </script>
</body>
</html>
